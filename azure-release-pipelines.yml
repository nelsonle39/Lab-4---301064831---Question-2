trigger:
  branches:
    include:
      - main

pool:
  name: Default

stages:
  # Build Stage
  - stage: Build
    jobs:
      - job: Build
        steps:
          - task: UseDotNet@2
            inputs:
              packageType: sdk
              version: 8.x

          - script: dotnet build --configuration Release
            displayName: 'Build the Project'

          - script: dotnet publish --configuration Release -o $(Build.ArtifactStagingDirectory)
            displayName: 'Publish Artifacts'

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'drop'

  # Deployment Stage
  - stage: Deploy
    dependsOn: Build
    jobs:
      - deployment: DeployToLocal
        environment: 'LocalMachine'
        pool:
          name: Default
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    artifactName: 'drop'

                - script: |
                    cd C:\Deployments\WebApp
                    Write-Host "Current Directory: $(Get-Location)"
                    Write-Host "Files in Current Directory:"
                    Get-ChildItem

                    Write-Host "Running the .NET application..."
                    dotnet "Lab_3_301064831.dll"
                  displayName: 'Deploy and Run'
